# 概要設計（改訂版：サボり耐性＝一括キャッチアップ前提）

## 1. 全体アーキテクチャ概要

### 1.1 コンポーネント

- **VS Code**
  - 日次ノート生成（Copilot 等の AI 支援を前提）
  - スクリプト実行（ETL / 索引生成 / 抽出パック生成）
  - 仕様・規約文書の管理（AI 向け指示、タグ辞書、スキーマなど）
- **Obsidian**
  - ノート閲覧（daily / drafts / exports / index）
  - 探索（バックリンク、グラフ、リンク辿り）
  - 索引ノート（index/\*.md）を起点に原本ブロックへジャンプ
- **Vault（Markdown）**
  - 一次情報（文脈・長文・思考）を保持する“正”
- **SQLite（索引用 DB）**
  - INDEX から抽出した最小情報を保持（検索・フィルタ・一覧生成）
  - 原本へ戻るため `source_path` と `block_id` を必ず保持
- **Python スクリプト**
  - daily の INDEX を解析 → DB へ Upsert（ETL）
  - DB → index ノートをフル再生成
  - DB → exports 抽出パック生成（ブログ化入力素材）
  - （任意）daily フォーマット検証

### 1.2 データの流れ（概要）

1. ユーザーが自然文入力 → **AI が daily を生成**
2. ETL が daily の **INDEX だけ解析** → **SQLite へ Upsert**
3. 索引生成が SQLite から **index/\*.md をフル再生成**
4. 抽出パック生成が SQLite から **exports/\*.md を生成**
5. AI が exports を元に **drafts/\*.md（ブログ下書き）を作成**

### 1.3 Day1 チュートリアルの位置づけ

- 実装完了後に `docs/impl_steps.md`（仮）で「環境準備→初回 daily 作成→etl --full→build_index→Obsidian で確認」を手順化する
- 本概要設計では流れのみ示し、操作手順の細部は手順書へ委譲する

---

## 2. ディレクトリ設計（Vault 内）

```
vault/
  daily/                 # 日次ノート（YYYY-MM-DD.md）
  index/                 # 自動生成の索引ノート（一覧・導線）
    books/
    tags/
  exports/               # ブログ化用の抽出パック（AI入力素材）
  drafts/                # ブログ下書き（AI出力）
  taxonomy/
    tags.yml             # タグ辞書（approved/aliases/new運用）
  scripts/
    etl.py               # daily -> sqlite（冪等Upsert、キャッチアップ可能）
    build_index.py       # sqlite -> index/*.md（毎回フル再生成）
    export_pack.py       # sqlite -> exports/*.md
    validate_daily.py    # （任意）dailyフォーマット検証
  db/
    notes.sqlite         # 索引用DB
  docs/
    ai-instructions.md   # AI向け規約（Copilot用の“憲法”）
```

---

## 3. Daily ノート設計（JSON なし・長文 OK・固定文法）

### 3.1 Daily の役割分担

- **本文**：長文 OK（読書・記事メモ・振り返りの文脈）
- **Key Takeaways**：ブログ化の核（3〜7 個程度、ブロック ID 付き）
- **INDEX**：機械が読む契約（固定文法でパース →DB へ）
- **RAW**：入力原文（任意だが推奨。後から再整形したい時の保険）

### 3.2 セクション構成（推奨）

- YAML frontmatter（date/tags）
- Summary（短文）
- Reading / Article Notes（任意・長文 OK）
- Key Takeaways (indexed)（ブロック ID 付き）
- Log / Reflection（自由）
- INDEX（固定文法）
- RAW（入力原文）

### 3.3 ブロック ID 命名規則（安定運用）

- 形式：`^YYYYMMDD-<kind><n>`
- kind（用途別に固定）
  - takeaway: `t`（例：^20251213-t1）
  - learning: `l`
  - experiment: `e`
  - idea: `i`
  - action: `a`

### 3.4 INDEX 行の固定文法（機械契約）

- 1 行=1 アイテム
- 末尾に `^block-id` を必ず付ける
- タグは `#prefix:value` 形式で 0 個以上
- action のみ `effort=` と `status=` を必須

推奨例（学びは Takeaways へリンクして文脈へ戻れるようにする）：

- `- [learning] ![[daily/2025-12-13.md#^20251213-t1]] #book:開発生産性の教科書 #topic:reading ^20251213-l1`
- `- [idea] 新しいアイデアの短いラベル #topic:workflow ^20251213-i1`
- `- [action] 次にやる: 週次で指標を1つ決める effort=30 status=inbox #topic:productivity ^20251213-a1`

---

## 4. タグ設計（taxonomy/tags.yml）

### 4.1 タグ形式

- 基本：`prefix:value`
- INDEX 内では `#prefix:value` として記述

prefix 例：

- `book:`（書籍名）
- `tech:`（技術）
- `topic:`（テーマ）
- `src:`（work/personal）
- `new:`（辞書外の仮タグ）

### 4.2 辞書・alias・new 運用

- `approved`：正式タグ
- `aliases`：同義語 → 正式タグへの変換（例：pw → tech:playwright）
- `new:`：一時タグ（週次/月次で棚卸しして approved へ昇格/統合）

### 4.3 タグ運用プロセス（詳細は手順書で補足）

1. 日次では `#prefix:value` か `#new:`/`#tmp:` をそのまま許容
2. 週次棚卸しで `taxonomy/tags.yml` の approved/aliases を更新
3. 更新後に `python scripts/etl.py --full` を実行して正規化を反映

---

## 5. SQLite 設計（索引専用・冪等 Upsert 前提）

### 5.1 DB の目的

- INDEX から抽出した情報を検索・抽出・一覧生成に使う
- 長文本文は保持しない（原本は Markdown）
- 原本へ戻るため `source_path` と `block_id` を必ず保持する

### 5.2 一意制約（キャッチアップの鍵）

- 推奨：`UNIQUE(source_path, block_id)`
  - 何日サボっても全走査 →Upsert で最新に収束
  - 過去の daily を追記/修正しても再実行で反映

### 5.3 保持する最小項目（論理モデル）

- item
  - date（YYYY-MM-DD）
  - type（learning/experiment/idea/action）
  - text（短いラベル・要約）
  - source_path（daily/…）
  - block_id（^…）
  - effort_min（action のみ）
  - status（action のみ）
  - updated_at（更新用）
- tags（多対多）

---

## 6. スクリプト設計（役割と I/F）

### 6.1 etl.py（daily -> sqlite：キャッチアップ可能）

- 入力：`daily/*.md`
- 抽出対象：`## INDEX` セクションの行のみ
- 出力：`db/notes.sqlite`
- 挙動：
  - 全走査しても OK（初期はこれが最も安全）
  - (source_path, block_id)で Upsert
  - タグは `taxonomy/tags.yml` で正規化（aliases/new 運用）
  - 1 行失敗しても停止しない（失敗行をログ出力）
- CLI（案）：
  - `python scripts/etl.py`（通常。全走査でも差分でも実装可）
  - `python scripts/etl.py --full`（強制フル再構築：困ったらこれ）
  - `python scripts/etl.py --since 30`（直近 N 日だけ：高速化用）

### 6.2 build_index.py（sqlite -> index/\*.md：毎回フル再生成）

- 入力：`db/notes.sqlite`
- 出力：`index/ideas.md`, `index/actions.md`, `index/books/*.md` 等
- 挙動：
  - 毎回フル再生成（派生物なので作り直しが最も安全）
  - tmp に書いて置換（アトミック）で壊れにくくする
- CLI（案）：
  - `python scripts/build_index.py`

### 6.3 export_pack.py（sqlite -> exports/\*.md）

- 入力：`db/notes.sqlite`
- 出力：`exports/*.md`
- 用途：
  - ブログ化の入力素材を生成（タグ/期間/type で抽出）
  - exports にはブロック参照を並べ、必要なら Summary リンクも付ける
- CLI（案）：
  - `python scripts/export_pack.py --tag "book:開発生産性の教科書" --from 2025-11-01 --to 2025-12-31`

### 6.4 validate_daily.py（任意）

- 入力：`daily/*.md`
- 出力：違反箇所レポート
- チェック例：
  - INDEX が無い
  - block_id が無い
  - action に effort/status が無い
  - タグ形式が不正（#prefix:value でない）

---

## 7. 運用フロー（サボり耐性＝一括キャッチアップ）

### 7.1 日次（毎日）

1. VS Code で自然文を書く
2. AI で daily をテンプレに沿って生成
3. Obsidian で見返し・探索（追記するなら VS Code）

### 7.2 何日サボっても OK（キャッチアップ）

1. `python scripts/etl.py --full`
2. `python scripts/build_index.py`

### 7.3 ブログ化（任意）

1. `python scripts/export_pack.py ...` で exports 生成
2. AI で exports を記事化して drafts へ保存
3. Obsidian で drafts を見返し、必要なら原本ブロックへ戻って文脈補強

> 各フローの具体的な CLI 手順・画面確認は実装後に `docs/impl_steps.md`（仮）へ集約する。

---

## 8. AI 向け規約文書（docs/ai-instructions.md）

- 日次テンプレ・INDEX 文法・block_id 規則・タグ規約・スクリプト方針を明文化
- Copilot 等に参照させ、出力の揺れを抑える
- 新人が迷わないように「OK 例/NG 例」を含める
